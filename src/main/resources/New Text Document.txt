package com.se445g.SE_445_G_ETL.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.math.BigDecimal;
import java.time.LocalDate;

@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class EmployeeDTO {

    // TRƯỜNG MỚI ĐỂ PHÂN LOẠI
    // Sẽ là "DEPARTMENT", "EMPLOYEE", hoặc "SALARY"
    private String recordType;

    // Thông tin nhân viên
    private Integer employeeId;
    private String fullName;
    private String gender;
    private LocalDate dateOfBirth;
    private String hometown;
    private String phone;
    private String email;
    private String educationLevel;
    private String position;
    private LocalDate hireDate;
    private String employeeStatus;

    // Thông tin phòng ban
    private Integer departmentId;
    private String departmentName;
    private String departmentLocation;
    private String departmentPhone;
    private BigDecimal departmentBudgetVnd;
    private Integer managerId;

    // Thông tin lương
    private Integer salaryId;
    private BigDecimal amountVnd;
    private String currency;
    private String payFrequency;
    private BigDecimal bonusVnd;
    private LocalDate effectiveFrom;
    private LocalDate effectiveTo;
}
package com.se445g.SE_445_G_ETL.service.impl;

import com.opencsv.CSVReader;
import com.se445g.SE_445_G_ETL.config.RabbitMQConfig;
import com.se445g.SE_445_G_ETL.dto.EmployeeDTO;
import com.se445g.SE_445_G_ETL.entity.staging.STG_Department;
import com.se445g.SE_445_G_ETL.entity.staging.STG_Employee;
import com.se445g.SE_445_G_ETL.entity.staging.STG_Salary;
import com.se445g.SE_445_G_ETL.mapper.EmployeeMapper;
import com.se445g.SE_445_G_ETL.service.interf.CSVProducerService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.stereotype.Service;

import java.io.FileReader;
import java.math.BigDecimal;
import java.time.LocalDate;

@Service
@RequiredArgsConstructor
@Slf4j
public class CSVProducerServiceImpl implements CSVProducerService {

    private final RabbitTemplate rabbitTemplate;
    private final EmployeeMapper employeeMapper;

    // Định nghĩa các hằng số cho recordType
    private static final String TYPE_DEPT = "DEPARTMENT";
    private static final String TYPE_EMP = "EMPLOYEE";
    private static final String TYPE_SALARY = "SALARY";

    @Override
    public void sendCSVData(String departmentPath, String employeePath, String salaryPath) {
        log.info("Bắt đầu quá trình gửi dữ liệu CSV...");

        sendDepartments(departmentPath);
        sendEmployees(employeePath);
        sendSalaries(salaryPath);

        log.info("Đã gửi tất cả dữ liệu CSV lên RabbitMQ.");
    }

    private void sendDepartments(String departmentPath) {
        try (CSVReader reader = new CSVReader(new FileReader(departmentPath))) {
            String[] line;
            reader.readNext(); // Bỏ qua dòng tiêu đề
            log.info("Đang gửi dữ liệu Departments...");

            while ((line = reader.readNext()) != null) {
                // 1. Tạo entity tạm thời từ dữ liệu CSV
                STG_Department tempDept = STG_Department.builder()
                        .departmentId(Integer.parseInt(line[0]))
                        .name(line[1])
                        .location(line[2])
                        .phone(line[3])
                        .budgetVnd(new BigDecimal(line[4]))
                        .managerId(Integer.parseInt(line[5]))
                        .build();

                // 2. Dùng mapper để chuyển entity thành DTO
                EmployeeDTO dto = employeeMapper.departmentToDto(tempDept);

                // 3. Đặt recordType và gửi đi
                dto.setRecordType(TYPE_DEPT);
                sendToQueue(dto);
            }
            log.info("Hoàn thành gửi dữ liệu Departments.");
        } catch (Exception e) {
            log.error("Lỗi khi đọc file departments.csv: {}", e.getMessage(), e);
        }
    }

    private void sendEmployees(String employeePath) {
        try (CSVReader reader = new CSVReader(new FileReader(employeePath))) {
            String[] line;
            reader.readNext(); // Bỏ qua dòng tiêu đề
            log.info("Đang gửi dữ liệu Employees...");

            while ((line = reader.readNext()) != null) {
                // Tạo proxy cho department để set khóa ngoại
                STG_Department deptProxy = new STG_Department();
                deptProxy.setDepartmentId(Integer.parseInt(line[10]));

                // 1. Tạo entity tạm thời
                STG_Employee tempEmp = STG_Employee.builder()
                        .employeeId(Integer.parseInt(line[0]))
                        .fullName(line[1])
                        .gender(line[2])
                        .dateOfBirth(LocalDate.parse(line[3]))
                        .hometown(line[4])
                        .phone(line[5])
                        .email(line[6])
                        .educationLevel(line[7])
                        .position(line[8])
                        .hireDate(LocalDate.parse(line[9]))
                        .status(line[11])
                        .department(deptProxy) // Gán proxy
                        .build();

                // 2. Dùng mapper chuyển thành DTO
                EmployeeDTO dto = employeeMapper.employeeToDto(tempEmp);

                // 3. Đặt recordType và gửi đi
                dto.setRecordType(TYPE_EMP);
                sendToQueue(dto);
            }
            log.info("Hoàn thành gửi dữ liệu Employees.");
        } catch (Exception e) {
            log.error("Lỗi khi đọc file employees.csv: {}", e.getMessage(), e);
        }
    }

    private void sendSalaries(String salaryPath) {
        try (CSVReader reader = new CSVReader(new FileReader(salaryPath))) {
            String[] line;
            reader.readNext(); // Bỏ qua dòng tiêu đề
            log.info("Đang gửi dữ liệu Salaries...");

            while ((line = reader.readNext()) != null) {
                // Tạo proxy cho employee
                STG_Employee empProxy = new STG_Employee();
                empProxy.setEmployeeId(Integer.parseInt(line[1]));

                // 1. Tạo entity tạm thời
                STG_Salary tempSalary = STG_Salary.builder()
                        .salaryId(Integer.parseInt(line[0]))
                        .amountVnd(new BigDecimal(line[2]))
                        .currency(line[3])
                        .payFrequency(line[4])
                        .bonusVnd(new BigDecimal(line[5]))
                        .effectiveFrom(LocalDate.parse(line[6]))
                        .effectiveTo(line[7].isEmpty() ? null : LocalDate.parse(line[7]))
                        .employee(empProxy)
                        .build();

                // 2. Dùng mapper chuyển thành DTO
                EmployeeDTO dto = employeeMapper.salaryToDto(tempSalary);

                // 3. Đặt recordType và gửi đi
                dto.setRecordType(TYPE_SALARY);
                sendToQueue(dto);
            }
            log.info("Hoàn thành gửi dữ liệu Salaries.");
        } catch (Exception e) {
            log.error("Lỗi khi đọc file salaries.csv: {}", e.getMessage(), e);
        }
    }

    private void sendToQueue(EmployeeDTO dto) {
        rabbitTemplate.convertAndSend(
                RabbitMQConfig.EXCHANGE_NAME,
                RabbitMQConfig.EMPLOYEES_ROUTING_KEY,
                dto);
    }
}
package com.se445g.SE_445_G_ETL.service.impl;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.se445g.SE_445_G_ETL.config.RabbitMQConfig;
import com.se445g.SE_445_G_ETL.dto.EmployeeDTO;
import com.se445g.SE_445_G_ETL.dto.PerformanceDTO;
import com.se445g.SE_445_G_ETL.entity.staging.*;
import com.se445g.SE_445_G_ETL.mapper.EmployeeMapper;
import com.se445g.SE_445_G_ETL.mapper.PerformanceMapper;
import com.se445g.SE_445_G_ETL.repository.staging.*;
import com.se445g.SE_445_G_ETL.service.interf.ConsumerService;
import com.se445g.SE_445_G_ETL.validation.ValidationFactory;
import com.se445g.SE_445_G_ETL.validation.ValidationResult;
import com.se445g.SE_445_G_ETL.validation.component.ValidationRule;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@RequiredArgsConstructor
@Slf4j
public class ConsumerServiceImpl implements ConsumerService {

    // Mapper
    private final EmployeeMapper employeeMapper;
    private final PerformanceMapper performanceMapper;

    // Repositories
    private final STG_DepartmentRepository departmentRepository;
    private final STG_EmployeeRepository employeeRepository;
    private final STG_SalaryRepository salaryRepository;

    private final STG_PerformanceReviewRepository reviewRepository;
    private final STG_EmployeePerformanceRepository employeePerformanceRepository;
    private final STG_TaskPerformanceRepository taskPerformanceRepository;
    private final STG_DepartmentPerformanceRepository departmentPerformanceRepository;
    private final STG_KpiMetricsRepository kpiMetricsRepository;

    // Validation Factory
    private final ValidationFactory validationFactory;
    
    // Error Record Repository
    private final STG_ErrorRecordRepository errorRecordRepository;
    private final ObjectMapper objectMapper;

    @RabbitListener(queues = RabbitMQConfig.EMPLOYEES_QUEUE)
    @Transactional
    public void receiveCSVData(EmployeeDTO dto) {
        // 1. ÁP DỤNG VALIDATION ENGINE (COR + COMPOSITE)
        ValidationRule<EmployeeDTO> employeeChain = validationFactory.getChain();
        ValidationResult result = employeeChain.validate(dto);

        if (!result.isValid()) {
            handleValidationError(dto, result);
            return;
        }

        String type = dto.getRecordType();
        if (type == null) {
            log.warn("Đã nhận message không có recordType: {}", dto);
            return;
        }

        try {
            switch (type) {
                case "DEPARTMENT":
                    processDepartment(dto);
                    break;
                case "EMPLOYEE":
                    processEmployee(dto);
                    break;
                case "SALARY":
                    processSalary(dto);
                    break;
                default:
                    log.warn("Không nhận diện được recordType: '{}'", type);
            }
        } catch (Exception e) {
            log.error("Lỗi khi xử lý DTO (type: {}): {}", type, e.getMessage(), e);
        }
    }

    private void processDepartment(EmployeeDTO dto) {
        log.info("Processing DEPARTMENT: {}", dto.getDepartmentId());
        STG_Department department = employeeMapper.dtoToDepartment(dto);
        departmentRepository.save(department);
    }

    private void processEmployee(EmployeeDTO dto) {
        log.info("Processing EMPLOYEE: {}", dto.getEmployeeId());
        STG_Employee employee = employeeMapper.dtoToEmployee(dto);
        employeeRepository.save(employee);
    }

    private void processSalary(EmployeeDTO dto) {
        log.info("Processing SALARY for Employee: {}", dto.getEmployeeId());
        STG_Salary salary = employeeMapper.dtoToSalary(dto);
        salary.setSalaryId(null);
        salaryRepository.save(salary);
    }

    @RabbitListener(queues = RabbitMQConfig.PERFORMANCE_QUEUE)
    @Transactional
    public void receiveMySQLData(PerformanceDTO dto) {
        String type = dto.getRecordType();
        if (type == null) {
            log.warn("Đã nhận message không có recordType: {}", dto);
            return;
        }

        try {
            switch (type) {
                case "REVIEW":
                    processReview(dto);
                    break;
                case "EMPLOYEE_PERFORMANCE":
                    processEmployeePerformance(dto);
                    break;
                case "TASK_PERFORMANCE":
                    processTaskPerformance(dto);
                    break;
                case "DEPT_PERFORMANCE":
                    processDepartmentPerformance(dto);
                    break;
                case "KPI_METRIC":
                    processKpiMetric(dto);
                    break;
                default:
                    log.warn("Không nhận diện được recordType: '{}'", type);
            }
        } catch (Exception e) {
            log.error("Lỗi khi xử lý DTO (type: {}). DTO: {}. Lỗi: {}", type, dto, e.getMessage(), e);
            throw e; // Ném lại lỗi để transaction rollback và đưa vào DLQ (nếu có)
        }
    }

    private void processReview(PerformanceDTO dto) {
        log.info("Processing REVIEW: {}", dto.getReviewId());
        STG_PerformanceReview review = performanceMapper.dtoToReview(dto);
        review.setReviewId(null); // Luôn INSERT
        reviewRepository.save(review);
    }

    private void processEmployeePerformance(PerformanceDTO dto) {
        log.info("Processing EMPLOYEE_PERFORMANCE: {}", dto.getEmployeePerformanceId());
        STG_EmployeePerformance empPerf = performanceMapper.dtoToEmployeePerformance(dto);
        empPerf.setId(null); // Luôn INSERT
        employeePerformanceRepository.save(empPerf);
    }

    private void processTaskPerformance(PerformanceDTO dto) {
        log.info("Processing TASK_PERFORMANCE: {}", dto.getTaskId());
        STG_TaskPerformance taskPerf = performanceMapper.dtoToTaskPerformance(dto);
        taskPerf.setTaskId(null); // Luôn INSERT
        taskPerformanceRepository.save(taskPerf);
    }

    private void processDepartmentPerformance(PerformanceDTO dto) {
        log.info("Processing DEPT_PERFORMANCE: {}", dto.getDeptPerfId());
        STG_DepartmentPerformance deptPerf = performanceMapper.dtoToDepartmentPerformance(dto);
        deptPerf.setDeptPerfId(null); // Luôn INSERT
        departmentPerformanceRepository.save(deptPerf);
    }

    private void processKpiMetric(PerformanceDTO dto) {
        log.info("Processing KPI_METRIC: {}", dto.getKpiId());
        STG_KpiMetrics kpi = performanceMapper.dtoToKpiMetrics(dto);
        kpi.setKpiId(null); // Luôn INSERT
        kpiMetricsRepository.save(kpi);
    }

    private <T> void handleValidationError(T dto, ValidationResult result) {
        log.warn("Bản ghi có lỗi validation. Lưu vào STG_ErrorRecord.");
        try {
            STG_ErrorRecord errorRecord = new STG_ErrorRecord();
            
            String recordType = "UNKNOWN";
            if (dto instanceof EmployeeDTO) {
                recordType = ((EmployeeDTO) dto).getRecordType();
            } else if (dto instanceof PerformanceDTO) {
                 recordType = ((PerformanceDTO) dto).getRecordType();
            }
            
            errorRecord.setRecordType(recordType);
            // Convert DTO thành JSON để lưu toàn bộ bản ghi lỗi
            errorRecord.setRawData(objectMapper.writeValueAsString(dto)); 
            errorRecord.setErrors(String.join("\n", result.getErrors())); // Gộp list lỗi thành chuỗi
            
            errorRecordRepository.save(errorRecord);
            
        } catch (JsonProcessingException e) {
            log.error("Lỗi khi chuyển đổi DTO sang JSON để lưu STG_ErrorRecord: {}", e.getMessage(), e);
        }
    }
}
{"recordType":"DEPARTMENT","employeeId":null,"fullName":null,"gender":null,"dateOfBirth":null,"hometown":null,"phone":"0585732563","email":null,"educationLevel":null,"position":null,"hireDate":null,"employeeStatus":null,"departmentId":1,"departmentName":"Phòng Kinh doanh","departmentLocation":"Tầng 3","departmentPhone":"0585732563","departmentBudgetVnd":2283080234,"managerId":168,"salaryId":null,"amountVnd":null,"currency":null,"payFrequency":null,"bonusVnd":null,"effectiveFrom":null,"effectiveTo":null}